<html>
    <head>
        <meta charset="utf-8">
        <title>Snake game</title>

        <style>
            #screen {
                border: 10px solid #CCC;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                image-rendering: -moz-crisp-edges;
                width: 400px;
                height: 400px;
            }
        </style>
    </head>
    <body>
        <canvas id="screen" width="10" height="10"></canvas>
        <script>
            const screen = document.getElementById('screen')
            const context = screen.getContext('2d')
            
            // Rules layer
            function checkMapLimitationRule(keyPressed, state) {
                const moving = {
                        'ArrowUp': (state.player.y - 1 >= 0 ? true : false),
                        'ArrowDown': (state.player.y + 1 < screen.height ? true : false),
                        'ArrowRight': (state.player.x + 1 < screen.width ? true : false),
                        'ArrowLeft': (state.player.x - 1 >= 0 ? true : false),
                    }
                return moving[keyPressed]
            }

            function checkPlayerEatFruit(state) {
                if (state.player.x == state.fruit.x && state.player.y == state.fruit.y){
                    return true
                } else {
                    return false
                }
            }

            // Game layer
            function createGame() {
                const state = {
                    player: { 
                        x: 0, y: 0, score: 0
                    },
                    fruit: {
                        x:0, y:0
                    }
                }   // TODO continuosMove, change the direction with keyPressed
                    function movePlayerIfNecessary(keyPressed) {
                        if (checkMapLimitationRule(keyPressed, state)) {
                            if (keyPressed === 'ArrowUp') {
                                state.player.y = state.player.y - 1;
                            }
                            if (keyPressed === 'ArrowDown') {
                                state.player.y = state.player.y + 1;
                            }
                            if (keyPressed === 'ArrowRight') {
                                state.player.x = state.player.x + 1;
                            }
                            if (keyPressed === 'ArrowLeft') {
                                state.player.x = state.player.x - 1;
                            }                        
                            console.log(`Moving player with ${keyPressed}`)
                        } else {
                        console.log('You are at the edge of the map')
                        }
                    }
                    function increasePlayerScoreIfNecessary() {
                        if (checkPlayerEatFruit(state)) {
                            state.player.score += 1
                            console.log(state.player.score)
                        }                  
                    }
                    function replaceFruitIfNecessary() {
                        if (checkPlayerEatFruit(state)) {
                            min = Math.ceil(0);
                            max = Math.floor(9);
                            // TODO checkPlayerFruitPosition
                            state.fruit.x = Math.floor(Math.random() * (max - min + 1) + min);
                            state.fruit.y = Math.floor(Math.random() * (max - min + 1) + min);
                            console.log(`fruit x: ${state.fruit.x}, fruit y: ${state.fruit.y}`)
                        }
                    }
                return {
                    movePlayerIfNecessary,
                    increasePlayerScoreIfNecessary,
                    replaceFruitIfNecessary,
                    state
                }
            }

            const game = createGame()
            
            // Input layer
            document.addEventListener('keydown', handleKeydown)

            function handleKeydown(event) {
                const keyPressed = event.key

                game.movePlayerIfNecessary(keyPressed)
                game.increasePlayerScoreIfNecessary()

            }

            // Show layer
            renderScreen()

            function renderScreen() {
                context.clearRect(0, 0, 10, 10)

                context.fillStyle = 'black'
                context.fillRect(game.state.player.x, game.state.player.y, 1, 1)
                
                game.replaceFruitIfNecessary()
                context.fillStyle = 'green'
                context.fillRect(game.state.fruit.x, game.state.fruit.y, 1, 1)

                requestAnimationFrame(renderScreen)
            }
        </script>
    </body>
</html>